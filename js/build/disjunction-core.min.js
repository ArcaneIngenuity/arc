Disjunction=DJ={Core:{},Extensions:{}};disjunction=dj={WINDOW_CLASSES:true,WINDOW_CONSTANTS:true,PREFIXED_MARKUP:false,constants:{X:0,Y:1,Z:2},apps:{},pointer:undefined,setPointer:function(deviceIndex,xChannelIndex,yChannelIndex,selectChannelIndex){var pointer=this.pointer=new Disjunction.Core.Pointer;pointer.device=this.devices.array[deviceIndex];pointer.xChannel=pointer.device.channels[xChannelIndex];pointer.yChannel=pointer.device.channels[yChannelIndex];pointer.selectChannel=pointer.device.channels[selectChannelIndex]},update:function(deltaSec){this.devices.poll();for(var id in this.apps){var app=this.apps[id];app.update(deltaSec)}this.devices.flush()},start:function(){this.timer.callback=this.update.bind(this);this.timer.start()},initialise:function(){if(this.WINDOW_CLASSES){for(var c in Disjunction.Core){window[c]=Disjunction.Core[c]}for(var e in Disjunction.Extensions){window[e]=Disjunction.Extensions[e]}}if(this.WINDOW_CONSTANTS){for(var c in this.constants){window[c]=this.constants[c]}}this.builder=new Disjunction.Core.Builder(this.apps);this.services=new Disjunction.Core.ServiceHub(this);this.devices=new Disjunction.Core.DeviceHub(this)},go:function(dom){this.initialise();this.builder.buildAll(dom||document,this);console.log("go",this.pointer);this.start()}};Disjunction.Core.App=function(id,disjunction){this.DEBUG=true;this.disjunction=disjunction;this.id=id;var phaser=this.phaser=new Disjunction.Core.Phaser(this);var services=this.services=new Disjunction.Core.ServiceHub(this);this.model=undefined;this.view=undefined;this.dispose=function(){phaser.dispose();input.dispose();services.dispose()};this.update=function(deltaSec){phaser.update(deltaSec)}};if(disjunction.WINDOW_CLASSES)window.App=Disjunction.Core.App;Disjunction.Core.Builder=function(apps){var prefix=disjunction.PREFIXED_MARKUP?"dj-":"";var commonTagName=prefix+"common";var appTagName=prefix+"app";var devicesTagName=prefix+"devices";var deviceTagName=prefix+"device";var servicesTagName=prefix+"services";var serviceTagName=prefix+"service";var phasesTagName=prefix+"phases";var phaseTagName=prefix+"phase"+(prefix===""?"-":"");var pointerTagName=prefix+"pointer";var timerTagName=prefix+"timer";var DOMPhase=document.registerElement(phaseTagName,{prototype:Object.create(HTMLDivElement.prototype),"extends":"div"});this.tabIndex=undefined;var app;var currentPhaseName;var viewIDs={};this.buildCommon=function(containerDOM,disjunction){var commonDOM=containerDOM.getElementsByTagName(commonTagName)[0];console.log(commonTagName,commonDOM,containerDOM);var commonServicesDOM=commonDOM.getElementsByTagName(servicesTagName)[0];if(commonServicesDOM)this.addServices(commonServicesDOM,disjunction.services);var commonDevicesDOM=commonDOM.getElementsByTagName(devicesTagName)[0];if(commonDevicesDOM)this.addDevices(commonDevicesDOM,disjunction.devices);else throw"Error: <devices> must be specified, containing at least one <device>.";var domPointer=commonDOM.getElementsByTagName(pointerTagName)[0];if(domPointer){if(domPointer.hasAttribute("device")&&domPointer.hasAttribute("x")&&domPointer.hasAttribute("y")&&domPointer.hasAttribute("select")){var deviceIndexName=domPointer.getAttribute("device");var xChannelIndexName=domPointer.getAttribute("x");var yChannelIndexName=domPointer.getAttribute("y");var selectChannelIndexName=domPointer.getAttribute("select");var deviceIndex=disjunction.constants[deviceIndexName];var xChannelIndex=disjunction.constants[xChannelIndexName];var yChannelIndex=disjunction.constants[yChannelIndexName];var selectChannelIndex=disjunction.constants[selectChannelIndexName];disjunction.setPointer(deviceIndex,xChannelIndex,yChannelIndex,selectChannelIndex)}else throw"Error: <pointer> must have attributes 'device', 'x', 'y', 'select'."}else throw"Error: <pointer> must be specified, referencing a valid <device>.";var timerDOM=commonDOM.getElementsByTagName(timerTagName)[0];var classNamesJoined=timerDOM.className;var periodSec=parseFloat(timerDOM.getAttribute("period"));if(classNamesJoined.length>0){var classNames=classNamesJoined.split(" ");var className=classNames[0];var TimerClass=Disjunction.Extensions[className+"Timer"];if(TimerClass){disjunction.timer=new TimerClass(periodSec)}}};this.buildAll=function(dom,disjunction){this.buildCommon(dom,disjunction);this.buildApps(dom,disjunction)};this.buildApps=function(containerDOM,disjunction){var appDOMs=containerDOM.getElementsByTagName(appTagName);var length=appDOMs.length;for(var i=0;i<length;i++){var appDOM=appDOMs[i];if(appDOM.id===""||appDOM.className===""){throw"Error: All <app> elements must have id and class attributes."}var app=this.buildApp(appDOM,disjunction);apps[app.id]=app}};this.buildApp=function(appDOM,disjunction){var id=appDOM.id;var className=appDOM.className;app=new Disjunction.Core.App(id,disjunction);app.className=className;var appModelClassName=className+"Model";var AppModelClass=window[appModelClassName];if(AppModelClass){app.model=new AppModelClass}var domServices=appDOM.getElementsByTagName(servicesTagName)[0];if(domServices)this.addServices(domServices,app.services);var domPhases=appDOM.getElementsByTagName(phasesTagName)[0];if(domPhases)this.addPhases(domPhases);else throw"Error: <phases> must be specified, containing at least one <phase>.";var mouse=disjunction.devices.array[disjunction.constants.DEVICE_MOUSE];var keyboard=disjunction.devices.array[disjunction.constants.DEVICE_KEYBOARD];appDOM.addEventListener("mousedown",ES5.bind(mouse,mouse.receive));appDOM.addEventListener("mouseup",ES5.bind(mouse,mouse.receive));appDOM.addEventListener("mousemove",ES5.bind(mouse,mouse.receive));appDOM.addEventListener("keydown",ES5.bind(keyboard,keyboard.receive));appDOM.addEventListener("keyup",ES5.bind(keyboard,keyboard.receive));app.phaser.change(currentPhaseName);apps[app.id]=app;return app};this.buildByIds=function(ids){for(var i in ids){var id=ids[i];var app=this.buildById(id)}};this.buildById=function(id){var appDOM=document.getElementById(id);return this.buildApp(appDOM,disjunction)};this.addDevices=function(containerDOM,devices){for(var i=0;i<containerDOM.children.length;i++){var element=containerDOM.children[i];if(element.tagName.toLowerCase()===deviceTagName){var className=element.className;var Class=Disjunction.Extensions[className];if(Class){var deviceConstantName="DEVICE_"+className.replace("Device","").toUpperCase();var device=devices.add(new Class);disjunction.constants[deviceConstantName]=device;if(disjunction.WINDOW_CONSTANTS)window[deviceConstantName]=device}}}};this.addServices=function(containerDOM,services){for(var i=0;i<containerDOM.children.length;i++){var element=containerDOM.children[i];if(element.tagName.toLowerCase()===serviceTagName){var shortServiceName=element.className;var longServiceName=element.className+"Service";var Class=window[longServiceName];if(Class){var serviceConstantName="SERVICE_"+shortServiceName.toUpperCase();var service=services.add(new Class);disjunction.constants[serviceConstantName]=service;if(disjunction.WINDOW_CONSTANTS)window[serviceConstantName]=service}}}};this.addChildViews=function(view,element){for(var a=0;a<element.children.length;a++){var childElement=element.children[a];var id=childElement.id;id=id.length>0?id:undefined;if(id){if(viewIDs.hasOwnProperty(id)){throw"Multiple Views may not have the same name / ID. '"+id+"' already exists."}else{viewIDs[id]=true}}var classNamesJoined=childElement.className;var childView;if(classNamesJoined.length>0){var classNames=classNamesJoined.split(" ");var className=classNames[0];var Class=window[className+"View"];if(Class){childView=new Class;childView.dom=childElement;childView.id=id;view.addChild(childView);this.prepareElement(childElement,childView)}}if(childElement.children.length>0)this.addChildViews(childView?childView:view,childElement);else this.prepareElement(childElement,view)}};this.addPhases=function(containerDOM){var elements=containerDOM.getElementsByTagName("phase");if(elements.length)throw"Error: In DOM JS, use <"+phaseTagName+"> rather than <phase>.";for(var a=0;a<containerDOM.children.length;a++){var element=containerDOM.children[a];if(element.tagName.toLowerCase()===phaseTagName){this.tabIndex=0;var classNamesJoined=element.className;if(classNamesJoined.length>0){var classNames=classNamesJoined.split(" ");var className=classNames[0];var model,view,ctrl;var ModelClass=window[className+"Model"];if(ModelClass)model=new ModelClass;var ViewClass=window[className+"View"];if(ViewClass)view=new ViewClass(app,model);var CtrlClass=window[className+"Ctrl"];if(CtrlClass)ctrl=new CtrlClass(app,model);this.prepareElement(element,view);view.dom=element;var domRect=element.getBoundingClientRect();view.bounds.x0=Math.floor(domRect.left);view.bounds.y0=Math.floor(domRect.top);view.bounds.setWidth(domRect.width);view.bounds.setHeight(domRect.height);var shortPhaseName=className.replace("Phase","");var phase=new Disjunction.Core.Phase(shortPhaseName,model,view,ctrl);app.phaser.add(phase);if(element.children.length>0)this.addChildViews(view,element,domRect);if(element.current||element.hasAttribute("current")){currentPhaseName=className}}}}};this.prepareElement=function(element,view){element.view=view;element.onfocus=function(){this.view.takeFocus()}}};if(disjunction.WINDOW_CLASSES)window.Builder=Disjunction.Core.Builder;Disjunction.Core.Ctrl=function(app,model){this.app=app;this.model=model;this.phase=undefined;this.start=function(){};this.stop=function(){};this.simulate=function(deltaSec){}};if(disjunction.WINDOW_CLASSES)window.Ctrl=Disjunction.Core.Ctrl;Disjunction.Core.Device=function(numChannels){this.channels=[];this.numChannels=numChannels;this.eventBased=true;for(var i=0;i<this.numChannels;i++){this.channels[i]=new DeviceChannel}this.receive=function(event){};this.poll=function(){};this.dispose=function(){}};if(disjunction.WINDOW_CLASSES)window.Device=Disjunction.Core.Device;Disjunction.Core.DeviceChannel=function(){this.value=0;this.delta=undefined;this.consumed=false};if(disjunction.WINDOW_CLASSES)window.DeviceChannel=Disjunction.Core.DeviceChannel;Disjunction.Core.DeviceHub=function(dom){this.array=[];this.get=function(i){return this.array[i]};this.poll=function(){var numDevices=this.array.length;for(var i=0;i<numDevices;i++){var device=this.array[i];device.poll()}};this.flush=function(){var numDevices=this.array.length;for(var i=0;i<numDevices;i++){var device=this.array[i];if(device.eventBased){var numChannels=device.channels.length;for(var j=0;j<numChannels;j++){var channel=device.channels[j];channel.delta=0}}}};this.add=function(device){this.array.push(device);return this.array.length-1};this.dispose=function(){var array=this.array;for(var i=0;i<array.length;i++){array[i].dispose()}}};if(disjunction.WINDOW_CLASSES)window.DeviceHub=Disjunction.Core.DeviceHub;Disjunction.Core.Model=function(){this.journals={};this.addJournal=function(id,length){this.journals[id]=new Array(length)};this.updateJournals=function(){var journals=this.journals;for(var j in journals){var journal=this.journals[j];var entriesLength=journal.length;for(var e=0;e<entriesLength-1;e++){journal[e+1]=journal[e]}}};this.changed=function(id,indexB,indexA){indexA=indexA||0;indexB=indexB||1;var journal=this.journals[id];return journal[indexA]!=journal[indexB]};this.serialise=this.serialize=function(){};this.deserialise=this.deserialize=function(serialised){}};if(disjunction.WINDOW_CLASSES)window.Model=Disjunction.Core.Model;Disjunction.Core.Phase=function(name,model,view,ctrl){this.name=name;this.model=model;this.view=view;this.ctrl=ctrl;this.view.model=model;this.ctrl.model=model;this.app=undefined;this.setApp=function(app){this.app=app;this.ctrl.app=app;this.view.app=app;this.ctrl.phase=this;this.view.phase=this;this.view.root=this.view;if(this.view.children)this.setAppRecurse(this.view)};this.setAppRecurse=function(view){var numChildren=view.children.length;for(var i=0;i<numChildren;i++){var viewChild=view.children[i];viewChild.app=this.app;viewChild.phase=this;viewChild.root=view.root;if(viewChild.children)this.setAppRecurse(viewChild)}};this.start=function(){this.ctrl.start();this.view.startRecurse()};this.stop=function(){this.ctrl.stop();this.view.stop()};this.dispose=function(){ctrl.dispose();view.dispose()};this.update=function(deltaSec){var model=this.model;var view=this.view;var ctrl=this.ctrl;var pointer=disjunction.pointer;if(pointer){if(view.enabled){pointer.findTarget(view);pointer.updateSelectedness()}}if(pointer.pollFocus)pointer.pollFocus();model.updateJournals();var focus=disjunction.pointer.focus;var bubble=focus;if(bubble)bubble=bubble.input(deltaSec);ctrl.simulate(deltaSec);view.outputRecurse(deltaSec)}};if(disjunction.WINDOW_CLASSES)window.Phase=Disjunction.Core.Phase;Disjunction.Core.Phaser=function(app){var array={};this.phase=undefined;this.app=app;this.get=function(i){return this.array[i]};this.add=function(phase){if(phase.name){array[phase.name]=phase;phase.setApp(this.app);phase.view.disable()}else throw"Cannot register Phase using name '"+phase.name+"'."};this.change=function(name){if(this.phase){this.phase.stop();this.phase.view.disable()}this.phase=array[name];this.phase.view.enable();this.phase.start()};this.update=function(deltaSec){this.phase.update(deltaSec)};this.dispose=function(){for(var name in this.array){array[name].dispose()}}};if(disjunction.WINDOW_CLASSES)window.Phaser=Disjunction.Core.Phaser;Disjunction.Core.Point2=function(x,y){this.x=x||0;this.y=y||0;this.clone=function(){return new Disjunction.Core.Point2(this.x,this.y);clone}};Disjunction.Core.Point2.prototype.constructor=Disjunction.Core.Point2;if(disjunction.WINDOW_CLASSES)window.Point2=Disjunction.Core.Point2;Disjunction.Core.Pointer=function(){this.device=undefined;this.isSelected=false;this.wasSelected=false;this.target=undefined;this.targetLast=undefined;this.targetSelected=undefined;this.targetReleased=undefined;this.positionInTarget;this.position=new Disjunction.Core.Point2;this.entered=undefined;this.exited=undefined;this.focus=undefined;this.focusLast=undefined;this.xChannel=undefined;this.yChannel=undefined;this.selectChannel=undefined;this.dragging=undefined;this.targetSupplied=undefined;this.startDragTarget=function(){this.dragging=this.target};this.stopDragTarget=function(){this.dragging=undefined};this.setTargetLast=function(){this.targetLast=this.target};this.progressDrag=function(){this.dragging.bounds.x0+=this.xChannel.delta;this.dragging.bounds.x1+=this.xChannel.delta;this.dragging.bounds.y0+=this.yChannel.delta;this.dragging.bounds.y1+=this.yChannel.delta};this.hasChangedTarget=function(){return this.target!==this.targetLast};this.hasChangedSelected=function(){return this.isSelected!=this.wasSelected};this.isReleasedSelectedTarget=function(){return targetSelected===targetReleased};this.updateSelectedness=function(){this.wasSelected=this.isSelected;if(this.selectChannel.delta>0)this.isSelected=this.selectChannel.value>0};this.findTarget=function(view){var device=this.device;this.position.x=this.xChannel.value;this.position.y=this.yChannel.value;if(this.position.x!==undefined&&this.position.y!==undefined){var intersectedViews=[];this.getIntersectedViews(view,this.position,intersectedViews);this.setTargetLast();this.target=intersectedViews.length>0?intersectedViews[intersectedViews.length-1]:undefined;if(this.target){this.positionInTarget=this.position.clone();this.target.fromWorld(this.positionInTarget)}}};this.pollFocus=undefined;this.getIntersectedViews=function(viewRoot,pointerPosition,intersectedViews){var unvisited=[viewRoot];while(unvisited.length>0){var view=unvisited.shift();if(view.enabled&&view.children){for(var i=0;i<view.children.length;i++){var childView=view.children[i];if(childView.enabled){unvisited.push(childView)}}var pointerTargetPosition=this.positionInTarget=pointerPosition.clone();view.fromWorld(pointerTargetPosition);var inBounds=view.bounds.contains(pointerTargetPosition);var inGeometry=view.geometry?view.geometry.intersects(pointerTargetPosition):true;if(inBounds&&inGeometry)intersectedViews.push(view)}}};this.isIn=function(view){return view===this.target}};if(disjunction.WINDOW_CLASSES)window.Pointer=Disjunction.Core.Pointer;Disjunction.Core.ServiceHub=function(){this.array=[];this.get=function(i){return this.array[i]};this.add=function(service){var array=this.array;array.push(service);return array.length-1};this.dispose=function(){var array=this.array;for(var i=0;i<array.length;i++){array[i].dispose()}}};if(disjunction.WINDOW_CLASSES)window.ServiceHub=Disjunction.Core.ServiceHub;Disjunction.Core.Timeline=function(app,phase,model,view,ctrl){this.app=app;this.phase=phase;this.model=model;this.view=view;this.ctrl=ctrl;this.isToStart=function(){};this.isToFinish=function(){};this.start=function(){};this.stop=function(){};this.input=function(deltaSec){};this.simulate=function(deltaSec){}};if(disjunction.WINDOW_CLASSES)window.Timeline=Disjunction.Core.Timeline;Disjunction.Core.Timer=function(){this.lastUpdateSec=undefined;this.callback=undefined;this.start=function(){};this.stop=function(){};this.update=function(){var thisUpdateSec=(new Date).getTime();var lastUpdateSec=this.lastUpdateSec;this.lastUpdateSec=thisUpdateSec;var deltaSec=(thisUpdateSec-(lastUpdateSec||thisUpdateSec))/1e3;if(this.callback){this.callback(deltaSec)}}};if(disjunction.WINDOW_CLASSES)window.Timer=Disjunction.Core.Timer;Disjunction.Core.View=function(app,model){this.id=undefined;this.app=app;this.model=model;this.phase=undefined;this.enabled=true;this.parent=undefined;this.children=[];this.root=undefined;this.body=undefined;this.bounds=undefined;this.interactor=undefined;this.interactors=[];this.start=function(){};this.stop=function(){};this.input=function(deltaSec){};this.output=function(deltaSec){};this.outputPost=function(deltaSec){};this.enable=function(){this.enabled=true;this.show()};this.disable=function(){this.enabled=false;this.hide()};this.show=function(){};this.hide=function(){};this.outputRecurse=function(deltaSec){this.output(deltaSec);var children=this.children;if(children){var length=children.length;for(var i=0;i<length;i++){var child=children[i];if(child.enabled)child.outputRecurse(deltaSec)}}this.outputPost(deltaSec)};this.bringToFore=function(child){var index=this.children.indexOf(child);if(index>-1){var temp=children[i];children[i]=children[j];children[j]=temp}};this.isRoot=function(){return this==this.root};this.addChild=function(childView){this.children.push(childView);childView.parent=this;childView.root=this.root;childView.app=this.app;childView.model=this.model};this.getChildById=function(id){var children=this.children;var length=children.length;for(var i=0;i<length;i++){var child=children[i];if(child.id===id){return child}}return undefined};this.hasChildren=function(){return this.children.length>0};this.startRecurse=function(){var children=this.children;if(children){var length=children.length;for(var i=0;i<length;i++){var child=children[i];child.startRecurse()}}this.start()};this.stopRecurse=function(deltaSec){this.stop();var children=this.children;if(children){var length=children.length;for(var i=0;i<length;i++){var child=children[i];child.stopRecurse()}}};this.getDepth=function(){var depth=0;var ancestor=this.parent;while(ancestor){depth++;ancestor=ancestor.parent}return depth};this.getLeaves=function(){var leaves=[];if(this.children.length==0)leaves.push(this);else{for(var i=0;i<this.children.length;i++){var child=this.children[i];var childLeaves=child.getLeaves();leaves.extend(childLeaves)}}return leaves};this.getLeavesEnabled=function(){var leaves=[];if(this.enabled){if(this.children.length==0)leaves.push(this);else{for(var i=0;i<this.children.length;i++){var child=this.children[i];var childLeaves=child.getLeaves();leaves.extend(childLeaves)}}}return leaves};this.makeLeaf=function(){this.children=undefined};this.isLeaf=function(){return this.children==undefined};this.toChild=function(position,child){position.x-=child.bounds.x0;position.y-=child.bounds.y0};this.fromChild=function(position,child){position.x+=child.bounds.x0;position.y+=child.bounds.y0};this.toParent=function(position){position.x+=this.bounds.x0;position.y+=this.bounds.y0};this.fromParent=function(position){position.x-=this.bounds.x0;position.y-=this.bounds.y0};this.fromWorld=function(position){var path=[];var view=this;path.push(view);while(view.parent){view=view.parent;path.unshift(view)}for(var i=0;i<path.length;i++){var view=path[i];position.x-=view.bounds.x0;position.y-=view.bounds.y0}};this.toWorld=function(position,parent){var view=this;while(view.parent){view=view.parent;position.x+=view.bounds.x0;position.y+=view.bounds.y0}};this.takeFocus=function(){disjunction.pointer.focus=this};this.addDOMEvent=function(obj,evt,fn){if(obj.addEventListener){obj.addEventListener(evt,fn,false)}else if(obj.attachEvent){obj.attachEvent("on"+evt,fn)}}};if(disjunction.WINDOW_CLASSES)window.View=Disjunction.Core.View;